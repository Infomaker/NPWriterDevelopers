<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>utils/PluginManager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Api.html">Api</a><ul class='methods'><li data-type='method'><a href="Api.html#call">call</a></li><li data-type='method'><a href="Api.html#getConfigValue">getConfigValue</a></li><li data-type='method'><a href="Api.html#init">init</a></li></ul></li><li><a href="APIManager.html">APIManager</a><ul class='methods'><li data-type='method'><a href="APIManager.html#expose">expose</a></li></ul></li><li><a href="Article.html">Article</a><ul class='methods'><li data-type='method'><a href="Article.html#clear">clear</a></li><li data-type='method'><a href="Article.html#copy">copy</a></li></ul></li><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#addExternalScript">addExternalScript</a></li><li data-type='method'><a href="Browser.html#getHash">getHash</a></li><li data-type='method'><a href="Browser.html#isSupported">isSupported</a></li><li data-type='method'><a href="Browser.html#reload">reload</a></li><li data-type='method'><a href="Browser.html#setHash">setHash</a></li><li data-type='method'><a href="Browser.html#setupHashHandler">setupHashHandler</a></li></ul></li><li><a href="Concept.html">Concept</a><ul class='methods'><li data-type='method'><a href="Concept.html#.getDefinitionForType">getDefinitionForType</a></li><li data-type='method'><a href="Concept.html#.setDefinitionDependingOnArrayOrObject">setDefinitionDependingOnArrayOrObject</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#deleteNode">deleteNode</a></li><li data-type='method'><a href="Document.html#getDocumentNodes">getDocumentNodes</a></li><li data-type='method'><a href="Document.html#insertBlockNode">insertBlockNode</a></li><li data-type='method'><a href="Document.html#insertInlineNode">insertInlineNode</a></li></ul></li><li><a href="Events.html">Events</a><ul class='methods'><li data-type='method'><a href="Events.html#_triggerEvent">_triggerEvent</a></li><li data-type='method'><a href="Events.html#documentChanged">documentChanged</a></li><li data-type='method'><a href="Events.html#documentIsUnsaved">documentIsUnsaved</a></li><li data-type='method'><a href="Events.html#documentSaved">documentSaved</a></li><li data-type='method'><a href="Events.html#documentSaveFailed">documentSaveFailed</a></li><li data-type='method'><a href="Events.html#off">off</a></li><li data-type='method'><a href="Events.html#on">on</a></li><li data-type='method'><a href="Events.html#onDocumentStartSaving">onDocumentStartSaving</a></li><li data-type='method'><a href="Events.html#triggerEvent">triggerEvent</a></li></ul></li><li><a href="FormAddComponent.html">FormAddComponent</a><ul class='methods'><li data-type='method'><a href="FormAddComponent.html#getCreateNewItem">getCreateNewItem</a></li></ul></li><li><a href="FormSearchComponent.html">FormSearchComponent</a><ul class='methods'><li data-type='method'><a href="FormSearchComponent.html#getCreateNewItem">getCreateNewItem</a></li></ul></li><li><a href="History.html">History</a><ul class='methods'><li data-type='method'><a href="History.html#cleanOldVersions">cleanOldVersions</a></li><li data-type='method'><a href="History.html#deleteHistory">deleteHistory</a></li><li data-type='method'><a href="History.html#get">get</a></li><li data-type='method'><a href="History.html#getHistory">getHistory</a></li><li data-type='method'><a href="History.html#isAvailable">isAvailable</a></li><li data-type='method'><a href="History.html#saveHistory">saveHistory</a></li></ul></li><li><a href="LabelProvider.html">LabelProvider</a></li><li><a href="NewsItem.html">NewsItem</a><ul class='methods'><li data-type='method'><a href="NewsItem.html#_getItemMetaExtPropertyByType">_getItemMetaExtPropertyByType</a></li><li data-type='method'><a href="NewsItem.html#_getLinksByType">_getLinksByType</a></li><li data-type='method'><a href="NewsItem.html#_getServices">_getServices</a></li><li data-type='method'><a href="NewsItem.html#_getSignalNodeByQcode">_getSignalNodeByQcode</a></li><li data-type='method'><a href="NewsItem.html#addAuthor">addAuthor</a></li><li data-type='method'><a href="NewsItem.html#addCategory">addCategory</a></li><li data-type='method'><a href="NewsItem.html#addChannel">addChannel</a></li><li data-type='method'><a href="NewsItem.html#addConceptProfile">addConceptProfile</a></li><li data-type='method'><a href="NewsItem.html#addLink">addLink</a></li><li data-type='method'><a href="NewsItem.html#addLocation">addLocation</a></li><li data-type='method'><a href="NewsItem.html#addSimpleAuthor">addSimpleAuthor</a></li><li data-type='method'><a href="NewsItem.html#addStory">addStory</a></li><li data-type='method'><a href="NewsItem.html#addTag">addTag</a></li><li data-type='method'><a href="NewsItem.html#createNewsPriority">createNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#getAuthors">getAuthors</a></li><li data-type='method'><a href="NewsItem.html#getCategories">getCategories</a></li><li data-type='method'><a href="NewsItem.html#getChannels">getChannels</a></li><li data-type='method'><a href="NewsItem.html#getContentMetaObjectById">getContentMetaObjectById</a></li><li data-type='method'><a href="NewsItem.html#getContentMetaObjectsByType">getContentMetaObjectsByType</a></li><li data-type='method'><a href="NewsItem.html#getContentProfiles">getContentProfiles</a></li><li data-type='method'><a href="NewsItem.html#getGuid">getGuid</a></li><li data-type='method'><a href="NewsItem.html#getLinkByType">getLinkByType</a></li><li data-type='method'><a href="NewsItem.html#getLinkByTypeAndRel">getLinkByTypeAndRel</a></li><li data-type='method'><a href="NewsItem.html#getLinksByType">getLinksByType</a></li><li data-type='method'><a href="NewsItem.html#getLocations">getLocations</a></li><li data-type='method'><a href="NewsItem.html#getMainChannel">getMainChannel</a></li><li data-type='method'><a href="NewsItem.html#getNewsPriority">getNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#getPubStart">getPubStart</a></li><li data-type='method'><a href="NewsItem.html#getPubStatus">getPubStatus</a></li><li data-type='method'><a href="NewsItem.html#getPubStop">getPubStop</a></li><li data-type='method'><a href="NewsItem.html#getSection">getSection</a></li><li data-type='method'><a href="NewsItem.html#getSections">getSections</a></li><li data-type='method'><a href="NewsItem.html#getStories">getStories</a></li><li data-type='method'><a href="NewsItem.html#getTags">getTags</a></li><li data-type='method'><a href="NewsItem.html#getTemporaryId">getTemporaryId</a></li><li data-type='method'><a href="NewsItem.html#hasTemporaryId">hasTemporaryId</a></li><li data-type='method'><a href="NewsItem.html#normalizeObject">normalizeObject</a></li><li data-type='method'><a href="NewsItem.html#removeAuthorByTitle">removeAuthorByTitle</a></li><li data-type='method'><a href="NewsItem.html#removeAuthorByUUID">removeAuthorByUUID</a></li><li data-type='method'><a href="NewsItem.html#removeChannel">removeChannel</a></li><li data-type='method'><a href="NewsItem.html#removeContentMetaObject">removeContentMetaObject</a></li><li data-type='method'><a href="NewsItem.html#removeLinkByUUID">removeLinkByUUID</a></li><li data-type='method'><a href="NewsItem.html#removeLinkByUUIDAndRel">removeLinkByUUIDAndRel</a></li><li data-type='method'><a href="NewsItem.html#removePubStart">removePubStart</a></li><li data-type='method'><a href="NewsItem.html#removePubStop">removePubStop</a></li><li data-type='method'><a href="NewsItem.html#removeSection">removeSection</a></li><li data-type='method'><a href="NewsItem.html#save">save</a></li><li data-type='method'><a href="NewsItem.html#setContentMetaObject">setContentMetaObject</a></li><li data-type='method'><a href="NewsItem.html#setGuid">setGuid</a></li><li data-type='method'><a href="NewsItem.html#setNewsPriority">setNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#setPubStart">setPubStart</a></li><li data-type='method'><a href="NewsItem.html#setPubStatus">setPubStatus</a></li><li data-type='method'><a href="NewsItem.html#setPubStop">setPubStop</a></li><li data-type='method'><a href="NewsItem.html#setSource">setSource</a></li><li data-type='method'><a href="NewsItem.html#setTemporaryId">setTemporaryId</a></li><li data-type='method'><a href="NewsItem.html#updateConceptProfile">updateConceptProfile</a></li><li data-type='method'><a href="NewsItem.html#updateLocation">updateLocation</a></li><li data-type='method'><a href="NewsItem.html#updateSection">updateSection</a></li><li data-type='method'><a href="NewsItem.html#updateStory">updateStory</a></li><li data-type='method'><a href="NewsItem.html#updateTag">updateTag</a></li></ul></li><li><a href="NewsMLArticle.html">NewsMLArticle</a></li><li><a href="NewsMLImporter.html">NewsMLImporter</a><ul class='methods'><li data-type='method'><a href="NewsMLImporter.html#getFirstElementWithTypeElement">getFirstElementWithTypeElement</a></li></ul></li><li><a href="NotFoundException.html">NotFoundException</a></li><li><a href="PluginManager.html">PluginManager</a><ul class='methods'><li data-type='method'><a href="PluginManager.html#_getValue">_getValue</a></li><li data-type='method'><a href="PluginManager.html#appendPluginScripts">appendPluginScripts</a></li><li data-type='method'><a href="PluginManager.html#getListOfPlugins">getListOfPlugins</a></li><li data-type='method'><a href="PluginManager.html#load">load</a></li><li data-type='method'><a href="PluginManager.html#registerPlugin">registerPlugin</a></li><li data-type='method'><a href="PluginManager.html#validatePluginPackage">validatePluginPackage</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'><li data-type='method'><a href="Router.html#checkForOKStatus">checkForOKStatus</a></li><li data-type='method'><a href="Router.html#createConceptItem">createConceptItem</a></li><li data-type='method'><a href="Router.html#get">get</a></li><li data-type='method'><a href="Router.html#getConceptItem">getConceptItem</a></li><li data-type='method'><a href="Router.html#getEndpoint">getEndpoint</a></li><li data-type='method'><a href="Router.html#getNewsItem">getNewsItem</a></li><li data-type='method'><a href="Router.html#getQuerystringFromParameters">getQuerystringFromParameters</a></li><li data-type='method'><a href="Router.html#getRequestPropertiesForMethod">getRequestPropertiesForMethod</a></li><li data-type='method'><a href="Router.html#post">post</a></li><li data-type='method'><a href="Router.html#postBinary">postBinary</a></li><li data-type='method'><a href="Router.html#proxy">proxy</a></li><li data-type='method'><a href="Router.html#put">put</a></li><li data-type='method'><a href="Router.html#toJson">toJson</a></li><li data-type='method'><a href="Router.html#updateConceptItem">updateConceptItem</a></li></ul></li><li><a href="Ui.html">Ui</a><ul class='methods'><li data-type='method'><a href="Ui.html#getComponent">getComponent</a></li><li data-type='method'><a href="Ui.html#showDialog">showDialog</a></li><li data-type='method'><a href="Ui.html#showMessageDialog">showMessageDialog</a></li><li data-type='method'><a href="Ui.html#showNotification">showNotification</a></li></ul></li><li><a href="Upload.html">Upload</a></li><li><a href="Validator.html">Validator</a><ul class='methods'><li data-type='method'><a href="Validator.html#addError">addError</a></li><li data-type='method'><a href="Validator.html#addInfo">addInfo</a></li><li data-type='method'><a href="Validator.html#addWarning">addWarning</a></li><li data-type='method'><a href="Validator.html#getMessages">getMessages</a></li><li data-type='method'><a href="Validator.html#hasMessages">hasMessages</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#removeControlCodes">removeControlCodes</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/PluginManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ResourceLoader from './ResourceLoader'
import isString from 'lodash/isString'
import sortBy from 'lodash/sortBy'
import 'whatwg-fetch'

class PluginManager {

    /**
     *
     * @param {NPWriterConfigurator} configurator The configurator
     * @param {APIManager} apiManager Requires an API manager that exposes endpoints to window.writer namespace
     */
    constructor(configurator, apiManager) {
        this.configurator = configurator
        this.registerPluginList = new Map()
        this.plugins = new Map()
        this.configurationCache = {};

        apiManager.expose('registerPlugin', this.registerPlugin.bind(this))
    }

    /**
     * Fetch a list of plugins from backend and parse result to JSON
     * @param configURL {string} A URL to the config file constraint plugins
     * @returns {Promise.&lt;TResult>|*}
     */
    getListOfPlugins(configURL) {
        return fetch(configURL, {
            credentials: "same-origin"
        })
            .then(response => response.json())
            .then(configJson => configJson.plugins)
    }

    /**
     * Appending script tag for plugins
     * @param plugins
     * @returns {Promise.&lt;TResult>|*} - Returns an array of promise objects
     */
    appendPluginScripts(plugins) {
        const resourceLoader = new ResourceLoader()
        return plugins.map(plugin => {
            return resourceLoader.load(plugin, 'js')
        })
    }


    appendPluginStylesheet(plugin) {
        const resourceLoader = new ResourceLoader()
        if (plugin.style) {
            resourceLoader.load(plugin, 'css')
        }
    }


    /**
     * Called by the plugin when it's done loading
     * @param pluginPackage
     */
    registerPlugin(pluginPackage) {
        if (!this.validatePluginPackage(pluginPackage)) {
            throw new Error('Package does not conform to package standard')
        }
        const pluginRegisterFunction = this.registerPluginList.get(pluginPackage.id);
        if (pluginRegisterFunction) {
            pluginRegisterFunction(pluginPackage);
        } else {
            console.info("Trying to call register on a plugin that's not registered with the writer", pluginPackage.id);
        }
    }

    /**
     * Checks if requires properties and methods exists on pluginPackage
     * @param pluginPackage
     * @returns {boolean}
     */
    validatePluginPackage(pluginPackage) {
        return !(typeof pluginPackage.configure !== 'function' || !pluginPackage.id || !pluginPackage.name || !pluginPackage.configure);
    }

    /**
     * Adding a register function for plugins. That's called later in registerPlugin method in the window object
     * @param plugins
     * @returns {Promise.&lt;*>}
     */
    load(plugins) {
        const enabledPlugins = plugins.filter((plugin) => {
            return plugin.enabled
        })

        this.pluginPackages = []
        const pluginRegistered = enabledPlugins.map((plugin, idx) => {
            return new Promise((resolve, reject) => {
                let resolved = false;

                this.registerPluginList.set(plugin.id, (pluginPackage) => {
                    pluginPackage.index = idx // Set the sort index for the package
                    this.pluginPackages.push({pluginPackage: pluginPackage, pluginConfigObject: plugin})
                    resolved = true;
                    this.plugins.set(plugin.id, plugin)
                    this.registerPluginList.delete(plugin.id)

                    // If plugin successfully registers then append the stylesheet provided for plugin
                    this.appendPluginStylesheet(plugin)

                    resolve();
                })

                setTimeout(() => {
                    if (!resolved) {
                        this.registerPluginList.delete(plugin.id) // Delete from loading list

                        if (plugin.mandatory) {
                            reject(plugin.id + " did not respond in time");
                        }
                        // plugin is not mandatory, resolve
                        console.warn(`Plugin ${plugin.id} did not respond, but marked as optional`)
                        resolve()
                    }
                }, 5000)
            })
        })

        const pluginsAppendPromise = this.appendPluginScripts(enabledPlugins)
        const allPromises = [...pluginsAppendPromise, ...pluginRegistered]
        return Promise.all(allPromises)
    }

    importPluginPackagesSortedByIndex() {

        let packages = sortBy(this.pluginPackages, [(pluginPackage) => {
            if (pluginPackage.pluginPackage.index === undefined) { // Undefined is a higher number than zero
                pluginPackage.pluginPackage.index = 0
            }
            return pluginPackage.pluginPackage.index;
        }])

        packages.forEach((pluginPackage) => {
            this.configurator.import(pluginPackage.pluginPackage, pluginPackage.pluginConfigObject)
        })
    }


    getConfigValue(obj, path, defaultValue) {

        var namePath,
            name,
            config = null;

        if (isString(obj)) {
            name = obj;
            namePath = name + '.data.' + path;
        }
        else if (obj.schema &amp;&amp; obj.schema.name) {
            name = obj.schema.name;
            namePath = name + '.data.' + path;
            config = obj.config;
        }
        else {
            throw new Error('Either string or plugin object with config is mandatory to get config value');
        }

        // If no config object is give and not cached, then fetch value
        if (config === null || false === namePath in this.configurationCache) {
            return this._getValue(name, namePath, path, defaultValue, config);
        }

        return this.configurationCache[namePath];
    }


    getHandlerCommandsForFile(fileType) {  // eslint-disable-line no-unused-vars
        // TODO: get commands for file drop from configurator
        return []
    }

    /**
     * Get and cache requested config path from within plugins data section
     * @protected
     *
     * @param type Plugin name
     * @param typePath Fake path with type used to cache value
     * @param path JSON path to get
     * @param defaultValue Optional, default value to return if not set
     * @param If not null, config structure to use instead of plugin config array
     */
    _getValue(name, namePath, path, defaultValue, config) {
        var ptr = this.plugins;
        var keys = path.split('.');
        var value = 'undefined' === typeof(defaultValue) ? undefined : defaultValue;

        if (config) {
            ptr = config;
        }
        else {

            let pluginData = this.plugins.get(name)
            if (pluginData) {
                ptr = pluginData.data
                // console.log("", pluginData.data[path]);
            }
            // for (var i = 0; i &lt; ptr.length; i++) {
            //     if (ptr[i].name === name) {
            //         ptr = ptr[i].data;
            //         break;
            //     }
            // }
        }

        if (!ptr) {
            return defaultValue;
        }

        defaultValue = value;
        for (var n = 0; n &lt; keys.length; n++) {
            if (typeof(ptr[keys[n]]) === "undefined") {
                value = defaultValue;
                break;
            }

            value = ptr[keys[n]];
            ptr = ptr[keys[n]];
        }

        if (config === null) {
            this.configurationCache[namePath] = value;
        }

        return value;
    }

}

export default PluginManager</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Jan 13 2017 14:25:35 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
