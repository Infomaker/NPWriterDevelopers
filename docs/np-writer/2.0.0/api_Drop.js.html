<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>api/Drop.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Api.html">Api</a><ul class='methods'><li data-type='method'><a href="Api.html#call">call</a></li><li data-type='method'><a href="Api.html#getConfigValue">getConfigValue</a></li><li data-type='method'><a href="Api.html#init">init</a></li></ul></li><li><a href="APIManager.html">APIManager</a><ul class='methods'><li data-type='method'><a href="APIManager.html#expose">expose</a></li></ul></li><li><a href="Article.html">Article</a><ul class='methods'><li data-type='method'><a href="Article.html#clear">clear</a></li><li data-type='method'><a href="Article.html#copy">copy</a></li></ul></li><li><a href="Browser.html">Browser</a><ul class='methods'><li data-type='method'><a href="Browser.html#getHash">getHash</a></li><li data-type='method'><a href="Browser.html#isSupported">isSupported</a></li><li data-type='method'><a href="Browser.html#reload">reload</a></li><li data-type='method'><a href="Browser.html#setHash">setHash</a></li><li data-type='method'><a href="Browser.html#setupHashHandler">setupHashHandler</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#deleteNode">deleteNode</a></li><li data-type='method'><a href="Document.html#getDocumentNodes">getDocumentNodes</a></li><li data-type='method'><a href="Document.html#handleDrag">handleDrag</a></li><li data-type='method'><a href="Document.html#insertBlockNode">insertBlockNode</a></li><li data-type='method'><a href="Document.html#insertInlineNode">insertInlineNode</a></li></ul></li><li><a href="Drop.html">Drop</a><ul class='methods'><li data-type='method'><a href="Drop.html#handleDrop">handleDrop</a></li><li data-type='method'><a href="Drop.html#handleEntityDrop">handleEntityDrop</a></li><li data-type='method'><a href="Drop.html#handleFilesDrop">handleFilesDrop</a></li><li data-type='method'><a href="Drop.html#handleUris">handleUris</a></li></ul></li><li><a href="Events.html">Events</a><ul class='methods'><li data-type='method'><a href="Events.html#_triggerEvent">_triggerEvent</a></li><li data-type='method'><a href="Events.html#documentChanged">documentChanged</a></li><li data-type='method'><a href="Events.html#documentIsUnsaved">documentIsUnsaved</a></li><li data-type='method'><a href="Events.html#off">off</a></li><li data-type='method'><a href="Events.html#on">on</a></li><li data-type='method'><a href="Events.html#onDocumentSaved">onDocumentSaved</a></li><li data-type='method'><a href="Events.html#onDocumentSaveFailed">onDocumentSaveFailed</a></li><li data-type='method'><a href="Events.html#onDocumentStartSaving">onDocumentStartSaving</a></li><li data-type='method'><a href="Events.html#triggerEvent">triggerEvent</a></li></ul></li><li><a href="NewsItem.html">NewsItem</a><ul class='methods'><li data-type='method'><a href="NewsItem.html#_getItemMetaExtPropertyByType">_getItemMetaExtPropertyByType</a></li><li data-type='method'><a href="NewsItem.html#_getLinksByType">_getLinksByType</a></li><li data-type='method'><a href="NewsItem.html#_getSignalNodeByQcode">_getSignalNodeByQcode</a></li><li data-type='method'><a href="NewsItem.html#addAuthor">addAuthor</a></li><li data-type='method'><a href="NewsItem.html#addCategory">addCategory</a></li><li data-type='method'><a href="NewsItem.html#addChannel">addChannel</a></li><li data-type='method'><a href="NewsItem.html#addConceptProfile">addConceptProfile</a></li><li data-type='method'><a href="NewsItem.html#addLink">addLink</a></li><li data-type='method'><a href="NewsItem.html#addLocation">addLocation</a></li><li data-type='method'><a href="NewsItem.html#addSimpleAuthor">addSimpleAuthor</a></li><li data-type='method'><a href="NewsItem.html#addStory">addStory</a></li><li data-type='method'><a href="NewsItem.html#addTag">addTag</a></li><li data-type='method'><a href="NewsItem.html#createNewsPriority">createNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#getAuthors">getAuthors</a></li><li data-type='method'><a href="NewsItem.html#getCategories">getCategories</a></li><li data-type='method'><a href="NewsItem.html#getChannels">getChannels</a></li><li data-type='method'><a href="NewsItem.html#getContentProfiles">getContentProfiles</a></li><li data-type='method'><a href="NewsItem.html#getGuid">getGuid</a></li><li data-type='method'><a href="NewsItem.html#getLinkByType">getLinkByType</a></li><li data-type='method'><a href="NewsItem.html#getLinkByTypeAndRel">getLinkByTypeAndRel</a></li><li data-type='method'><a href="NewsItem.html#getLinksByType">getLinksByType</a></li><li data-type='method'><a href="NewsItem.html#getLocations">getLocations</a></li><li data-type='method'><a href="NewsItem.html#getMainChannel">getMainChannel</a></li><li data-type='method'><a href="NewsItem.html#getNewsPriority">getNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#getPubStart">getPubStart</a></li><li data-type='method'><a href="NewsItem.html#getPubStatus">getPubStatus</a></li><li data-type='method'><a href="NewsItem.html#getPubStop">getPubStop</a></li><li data-type='method'><a href="NewsItem.html#getStories">getStories</a></li><li data-type='method'><a href="NewsItem.html#getTags">getTags</a></li><li data-type='method'><a href="NewsItem.html#isValid">isValid</a></li><li data-type='method'><a href="NewsItem.html#normalizeObject">normalizeObject</a></li><li data-type='method'><a href="NewsItem.html#removeAuthorByTitle">removeAuthorByTitle</a></li><li data-type='method'><a href="NewsItem.html#removeAuthorByUUID">removeAuthorByUUID</a></li><li data-type='method'><a href="NewsItem.html#removeChannel">removeChannel</a></li><li data-type='method'><a href="NewsItem.html#removeLinkByUUID">removeLinkByUUID</a></li><li data-type='method'><a href="NewsItem.html#removeLinkByUUIDAndRel">removeLinkByUUIDAndRel</a></li><li data-type='method'><a href="NewsItem.html#removePubStart">removePubStart</a></li><li data-type='method'><a href="NewsItem.html#removePubStop">removePubStop</a></li><li data-type='method'><a href="NewsItem.html#save">save</a></li><li data-type='method'><a href="NewsItem.html#setGuid">setGuid</a></li><li data-type='method'><a href="NewsItem.html#setNewsPriority">setNewsPriority</a></li><li data-type='method'><a href="NewsItem.html#setPubStart">setPubStart</a></li><li data-type='method'><a href="NewsItem.html#setPubstatus">setPubstatus</a></li><li data-type='method'><a href="NewsItem.html#setPubStop">setPubStop</a></li><li data-type='method'><a href="NewsItem.html#setSource">setSource</a></li><li data-type='method'><a href="NewsItem.html#updateConceptProfile">updateConceptProfile</a></li><li data-type='method'><a href="NewsItem.html#updateLocation">updateLocation</a></li><li data-type='method'><a href="NewsItem.html#updateStory">updateStory</a></li><li data-type='method'><a href="NewsItem.html#updateTag">updateTag</a></li></ul></li><li><a href="NewsMLArticle.html">NewsMLArticle</a></li><li><a href="NewsMLImporter.html">NewsMLImporter</a><ul class='methods'><li data-type='method'><a href="NewsMLImporter.html#getFirstElementWithTypeElement">getFirstElementWithTypeElement</a></li></ul></li><li><a href="NotFoundException.html">NotFoundException</a></li><li><a href="PluginManager.html">PluginManager</a><ul class='methods'><li data-type='method'><a href="PluginManager.html#_getValue">_getValue</a></li><li data-type='method'><a href="PluginManager.html#appendPluginScripts">appendPluginScripts</a></li><li data-type='method'><a href="PluginManager.html#getListOfPlugins">getListOfPlugins</a></li><li data-type='method'><a href="PluginManager.html#load">load</a></li><li data-type='method'><a href="PluginManager.html#registerPlugin">registerPlugin</a></li><li data-type='method'><a href="PluginManager.html#validatePluginPackage">validatePluginPackage</a></li></ul></li><li><a href="Router.html">Router</a><ul class='methods'><li data-type='method'><a href="Router.html#ajax">ajax</a></li><li data-type='method'><a href="Router.html#checkForOKStatus">checkForOKStatus</a></li><li data-type='method'><a href="Router.html#get">get</a></li><li data-type='method'><a href="Router.html#getEndpoint">getEndpoint</a></li><li data-type='method'><a href="Router.html#post">post</a></li><li data-type='method'><a href="Router.html#postBinary">postBinary</a></li><li data-type='method'><a href="Router.html#proxy">proxy</a></li><li data-type='method'><a href="Router.html#put">put</a></li></ul></li><li><a href="Ui.html">Ui</a><ul class='methods'><li data-type='method'><a href="Ui.html#showDialog">showDialog</a></li><li data-type='method'><a href="Ui.html#showMessageDialog">showMessageDialog</a></li><li data-type='method'><a href="Ui.html#showNotification">showNotification</a></li></ul></li><li><a href="Upload.html">Upload</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">api/Drop.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import entityMatcher from './EntityMatcher'

/**
 * @class Drop
 *
 * Drop handling methods. All methods available directly in the context.api object.
 */
class Drop {

    /**
     * Handles dropped files
     * Called internally from the Writer, should not be used directly by plugins.
     *
     * @param {object} evt Drop event
     * @param {Surface} surface Substance surface
     * @param {PluginManager} pluginManager
     * @param {object} plugin
     * @param {object} context
     * @returns {boolean}
     */
    handleFilesDrop(evt, surface, pluginManager, plugin, context) {

        if (typeof window.FileReader === 'undefined') {
            if (typeof window.FileReader === 'undefined') {
                console.error('Drop not available, window.FileReader undefined');
                return false;
            }
        }

        try {
            for (var n = 0; n &lt; evt.dataTransfer.files.length; n++) {
                var file = evt.dataTransfer.files[n];
                var commands = pluginManager.getHandlerCommandsForFile(file.type);
                commands.forEach(function (command) {
                    if (!plugin || plugin === command) {
                        surface.executeCommand(command, {type: 'file', data: file, context: context});
                    }
                });
            }
            return true;
        } catch (e) {
            console.log(e);
        }
        return false;
    }

    /**
     * Handles pasted or dropped uris.
     * Called internally from the Writer, should not be used directly by plugins.
     *
     * @param {array} uris List of uris
     * @param {Surface} surface Substance surface
     * @param {object} plugin
     * @param {object} context
     * @returns {boolean}
     */
    handleUris(uris, surface, plugin, context) {

        var pluginManager = context.api.pluginManager;

        try {
            if (uris) {
                for (var n = 0; n &lt; uris.length; n++) {
                    var uri = uris[n];

                    var result = entityMatcher.exec(uri);

                    if (result) {
                        this.handleEntityDrop(
                            {type: result[1], uuid: result[2], title: result[3]},
                            surface, plugin, context);
                    } else {
                        var dropCommands = pluginManager.getHandlerCommands('uri', uri);
                        if (dropCommands.length === 0) {
                            console.warn('No plugin found to handle drop for uri &lt;' + uri + '>');
                            return false;
                        }

                        dropCommands.forEach(function (commandName) { /* jshint ignore:line */
                            if (!plugin || commandName === plugin) {
                                if (context) {
                                    surface.executeCommand(commandName,
                                        {type: 'uri', data: uri, context: context});
                                } else {
                                    surface.executeCommand(commandName, uri);
                                }
                            }
                        });
                    }
                }

                return true;
            }
        }
        catch
            (e) {
            console.log(e);
            return false;
        }
    };

    /**
     * Handles dropped entities.
     * Called internally from the Writer, should not be used directly by plugins.
     *
     * @param {object} data Entity object
     * @param {Surface} surface Substance surface
     * @param {object} plugin
     * @param {object} context
     * @returns {boolean}
     */
    handleEntityDrop(data, surface, plugin, context) {
        var pluginManager = context.api.pluginManager;

        this.router.get('/api/newsitem/' + data.uuid, {imType: data.type})
            .done(function (str) {

                var dom = $.parseXML(str),
                    itemClass = dom.querySelector(
                        'newsItem > itemMeta > itemClass').getAttribute('qcode');

                var newsItemCommands = pluginManager.getHandlerCommands('newsItem', itemClass);

                if (newsItemCommands.length === 0) {
                    console.warn('No plugin found to handle drop of type newsitem', data.type, data.uuid);
                    return false;
                }

                newsItemCommands.forEach(function (commandName) {
                    // Execute for all plugins if plugin is not specified, otherwise plugin name have to match
                    if (!plugin || plugin === commandName) {
                        surface.executeCommand(commandName,
                            {type: 'newsItem', data: dom, context: context});
                    }
                });

            })
            .error(function (error, xhr, text) {
                // TODO: Display error message
                console.error(error, xhr, text);
            });

    };


    extractUrisFromDrop(dataTransfer) {
        var uriList = dataTransfer.types.find(function (item) {
            return item === 'text/uri-list';
        });

        if (uriList) {
            return dataTransfer.getData(uriList).split('\n').filter(function (item) {
                return !item.startsWith('#');
            });
        }

        var textData = dataTransfer.getData('text/plain');
        var match = /(https?:\/\/[^\s]+)/.exec(textData);
        if (match) {
            return match[1];
        }

        return undefined;
    }

    /**
     * Handles drop.
     *
     * @param {Surface} surface Substance surface
     * @param {object} evt Drop event object
     * @param {object} plugin
     * @param {object} context
     */
    handleDrop(surface, evt, plugin, context) {
        var isStandardDrop = evt.dataTransfer.files.length === 0;
        var pluginManager = context.api.pluginManager

        if (isStandardDrop) {
            var uris = this.extractUrisFromDrop(evt.dataTransfer);

            this.handleUris(uris, surface, plugin, context);
        } else {
            this.handleFilesDrop(evt, surface, pluginManager, plugin, context);
        }

    };

}


export default Drop
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Thu Nov 03 2016 21:54:28 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
